#!/bin/bash
set -e

# Bu script, Docker Compose iÃ§in son .env dosyasÄ±nÄ± oluÅŸturur.
# Sadece `source` komutlarÄ±nÄ± kopyalamak yerine, bu dosyalarÄ± gerÃ§ekten "source" ederek
# iÃ§lerindeki deÄŸiÅŸkenleri Ã§Ã¶zer ve nihai KEY=VALUE Ã§iftlerini yazar.

PROFILE=${1:-dev}
CONFIG_DIR="../sentiric-config/environments"
OUTPUT_FILE=".env.generated"
SECRETS_FILE="${CONFIG_DIR}/common/secrets.env"
PROFILE_FILE="${CONFIG_DIR}/profiles/${PROFILE}.env"

if [ ! -f "$PROFILE_FILE" ]; then
    echo "âŒ HATA: Profil dosyasÄ± bulunamadÄ±: $PROFILE_FILE"
    exit 1
fi

echo "ğŸ”§ YapÄ±landÄ±rma dosyasÄ± '${OUTPUT_FILE}' oluÅŸturuluyor (Profil: ${PROFILE})..."

# Ã‡Ä±ktÄ± dosyasÄ±nÄ± temizle ve baÅŸlÄ±k ekle
echo "# Auto-generated by Sentiric Orchestrator for profile: ${PROFILE}" > "$OUTPUT_FILE"
echo "# DO NOT EDIT THIS FILE MANUALLY" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# GeÃ§ici bir shell script'i oluÅŸturarak tÃ¼m source iÅŸlemlerini yap
TEMP_SCRIPT=$(mktemp)
# Profilden gelen source satÄ±rlarÄ±nÄ± geÃ§ici scripte yaz
grep '^source ' "$PROFILE_FILE" > "$TEMP_SCRIPT"

# SÄ±rlarÄ± da ekle, eÄŸer varsa
if [ -f "$SECRETS_FILE" ]; then
    # SÄ±rlardaki yorumlarÄ± ve boÅŸ satÄ±rlarÄ± temizle
    grep -vE '^\s*#|^\s*$' "$SECRETS_FILE" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
fi

# GeÃ§ici script'i Ã§alÄ±ÅŸtÄ±r ve sadece bÃ¼yÃ¼k harfle baÅŸlayan deÄŸiÅŸkenleri al
# Bu, PATH, HOME gibi sistem deÄŸiÅŸkenlerinin sÄ±zmasÄ±nÄ± engeller
(
  # shellcheck source=/dev/null
  source "$TEMP_SCRIPT"
  # TÃ¼m deÄŸiÅŸkenleri yazdÄ±r ve sadece BÃœYÃœK harfle baÅŸlayanlarÄ± filtrele
  env | grep '^[A-Z_][A-Z0-9_]*='
) >> "$OUTPUT_FILE"

# GeÃ§ici script'i sil
rm -f "$TEMP_SCRIPT"

# Dinamik deÄŸiÅŸkenleri ekle
echo "" >> "$OUTPUT_FILE"
echo "# Dynamically added by Orchestrator" >> "$OUTPUT_FILE"
# WSL'de doÄŸru IP'yi bulmak iÃ§in daha saÄŸlam bir yÃ¶ntem
DETECTED_IP=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
echo "PUBLIC_IP=${DETECTED_IP}" >> "$OUTPUT_FILE"
TAG=${TAG:-latest}
echo "TAG=${TAG}" >> "$OUTPUT_FILE"
echo "CONFIG_REPO_PATH=../sentiric-config" >> "$OUTPUT_FILE"

# SonuÃ§ dosyasÄ± iÃ§indeki potansiyel Windows satÄ±r sonlarÄ±nÄ± (CR) temizle
sed -i 's/\r$//' "$OUTPUT_FILE"

echo "âœ… YapÄ±landÄ±rma baÅŸarÄ±yla oluÅŸturuldu."