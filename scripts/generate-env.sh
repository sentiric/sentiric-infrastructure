#!/bin/bash

# Hata ayÄ±klama modunu aÃ§: Her komutu Ã§alÄ±ÅŸtÄ±rmadan Ã¶nce yazdÄ±r.
set -x 
# Herhangi bir komut hata verirse script'i durdur.
set -e
# Pipe iÃ§indeki bir komut hata verirse tÃ¼m pipe'Ä± baÅŸarÄ±sÄ±z say.
set -o pipefail

PROFILE=${1:-dev}

echo "--- Script BaÅŸladÄ±: generate-env.sh ---"
echo "Profil: ${PROFILE}"

# --- Temel Dizinleri TanÄ±mla ---
echo "AdÄ±m 1: Dizin yollarÄ± hesaplanÄ±yor..."
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
INFRA_DIR=$(dirname "$SCRIPT_DIR")
WORKSPACE_DIR=$(dirname "$INFRA_DIR")
echo "-> Ã‡alÄ±ÅŸma AlanÄ±: ${WORKSPACE_DIR}"
echo "-> AltyapÄ± Dizini: ${INFRA_DIR}"
echo "-> Config Dizini: ${WORKSPACE_DIR}/sentiric-config/environments"

# --- Kaynak ve Hedef DosyalarÄ± TanÄ±mla ---
CONFIG_DIR="${WORKSPACE_DIR}/sentiric-config/environments"
OUTPUT_FILE="${INFRA_DIR}/.env.generated"
PROFILE_FILE="${CONFIG_DIR}/profiles/${PROFILE}.env"

if [ ! -f "$PROFILE_FILE" ]; then
    echo "âŒ HATA: Profil dosyasÄ± bulunamadÄ±: $PROFILE_FILE"
    exit 1
fi
echo "AdÄ±m 2: Profil dosyasÄ± bulundu: ${PROFILE_FILE}"

echo "ğŸ”§ YapÄ±landÄ±rma dosyasÄ± '${OUTPUT_FILE}' oluÅŸturuluyor..."

# --- Ã‡Ä±ktÄ± DosyasÄ±nÄ± BaÅŸlat ---
> "$OUTPUT_FILE"
{
    echo "# Auto-generated by Sentiric Orchestrator for profile: ${PROFILE}"
    echo "# DO NOT EDIT THIS FILE MANUALLY"
    echo ""
} >> "$OUTPUT_FILE"
echo "AdÄ±m 3: Ã‡Ä±ktÄ± dosyasÄ± baÅŸlatÄ±ldÄ±: ${OUTPUT_FILE}"

# --- DosyalarÄ± BirleÅŸtir ---
echo "AdÄ±m 4: Profildeki kaynak dosyalarÄ± birleÅŸtiriliyor..."
# Profil dosyasÄ±nÄ± satÄ±r satÄ±r oku
while IFS= read -r line || [[ -n "$line" ]]; do
    line_clean=$(echo "$line" | tr -d '\r') # SatÄ±r sonu karakterini temizle

    if [[ $line_clean == source* ]]; then
        relative_path=$(echo "$line_clean" | cut -d' ' -f2)
        source_file="${CONFIG_DIR}/${relative_path}"
        
        if [ -f "$source_file" ]; then
            echo "  -> Ä°ÅŸleniyor: ${source_file}"
            {
                echo "# Included from: ${relative_path}"
                # Kaynak dosyayÄ± da okurken satÄ±r sonlarÄ±nÄ± temizle
                grep -vE '^\s*#|^\s*$' "$source_file" | tr -d '\r'
                echo ""
            } >> "$OUTPUT_FILE"
        else
            echo "âš ï¸ UYARI: Kaynak dosyasÄ± bulunamadÄ±, atlanÄ±yor: $source_file"
        fi
    fi
done < "$PROFILE_FILE"
echo "AdÄ±m 4 tamamlandÄ±."

# --- SÄ±rlarÄ± ve Dinamik DeÄŸiÅŸkenleri Ekle ---
echo "AdÄ±m 5: SÄ±rlar ve dinamik deÄŸiÅŸkenler ekleniyor..."
SECRETS_FILE="${CONFIG_DIR}/common/secrets.env"
if [ -f "$SECRETS_FILE" ]; then
    echo "  -> SÄ±rlar ekleniyor..."
    {
        echo "# Included from: common/secrets.env"
        grep -vE '^\s*#|^\s*$' "$SECRETS_FILE" | tr -d '\r'
        echo ""
    } >> "$OUTPUT_FILE"
fi

echo "# Dynamically added by Orchestrator" >> "$OUTPUT_FILE"
# WSL'de 'ip' komutu yoksa hata vermemesi iÃ§in kontrol ekliyoruz
DETECTED_IP="127.0.0.1" # VarsayÄ±lan deÄŸer
if command -v ip &> /dev/null; then
    DETECTED_IP=$(ip addr | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}' | cut -d'/' -f1 | head -n 1)
fi
echo "PUBLIC_IP=${DETECTED_IP}" >> "$OUTPUT_FILE"
TAG=${TAG:-latest}
echo "TAG=${TAG}" >> "$OUTPUT_FILE"
echo "CONFIG_REPO_PATH=../sentiric-config" >> "$OUTPUT_FILE"
echo "AdÄ±m 5 tamamlandÄ±."

echo "âœ… YapÄ±landÄ±rma baÅŸarÄ±yla oluÅŸturuldu."
echo "--- Script Bitti: generate-env.sh ---"