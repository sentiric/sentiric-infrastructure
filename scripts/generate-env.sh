#!/bin/bash
set -e

PROFILE=${1:-dev} # Argüman yoksa varsayılan 'dev'
CONFIG_DIR="../sentiric-config/environments"
OUTPUT_FILE=".env.${PROFILE}"
SECRETS_FILE="${CONFIG_DIR}/common/secrets.env"

echo "# Auto-generated for profile: ${PROFILE}" > "$OUTPUT_FILE"
echo "# Do not edit this file directly. Edit files in ${CONFIG_DIR}" >> "$OUTPUT_FILE"
echo ""

# Profil dosyasındaki 'include' direktiflerini oku ve işle
while IFS= read -r line || [[ -n "$line" ]]; do
    if [[ "$line" == include* ]]; then
        path_to_include=$(echo "$line" | cut -d' ' -f2)
        # Wildcard (*) desteği
        for file in $(find "${CONFIG_DIR}" -path "${CONFIG_DIR}/${path_to_include}"); do
            if [ -f "$file" ]; then
                echo "" >> "$OUTPUT_FILE"
                echo "# Included from: $(basename "$file")" >> "$OUTPUT_FILE"
                cat "$file" >> "$OUTPUT_FILE"
            fi
        done
    else
        echo "$line" >> "$OUTPUT_FILE"
    fi
done < "${CONFIG_DIR}/profiles/${PROFILE}.env"

# Sırları (secrets) ekle
if [ -f "$SECRETS_FILE" ]; then
    echo "" >> "$OUTPUT_FILE"
    echo "# Included from: secrets.env" >> "$OUTPUT_FILE"
    cat "$SECRETS_FILE" >> "$OUTPUT_FILE"
fi

# Dinamik değişkenleri ekle
echo "" >> "$OUTPUT_FILE"
echo "# Dynamically added by Orchestrator" >> "$OUTPUT_FILE"
DETECTED_IP=$(ip route get 1.1.1.1 2>/dev/null | awk '{print $7}' || hostname -I | awk '{print $1}')
echo "PUBLIC_IP=${DETECTED_IP}" >> "$OUTPUT_FILE"
TAG=${TAG:-latest}
echo "TAG=${TAG}" >> "$OUTPUT_FILE"

echo "✅ Yapılandırma dosyası '${OUTPUT_FILE}' başarıyla oluşturuldu."