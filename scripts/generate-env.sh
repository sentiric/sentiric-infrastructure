#!/bin/bash
set -e
set -o pipefail

# Bu script, Docker Compose için son .env dosyasını oluşturur.
# Maksimum uyumluluk için sadece temel bash komutları kullanır
# ve boş dosyaları sorunsuz bir şekilde işler.

PROFILE=${1:-dev}

# --- Temel Dizinleri Tanımla ---
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
INFRA_DIR=$(dirname "$SCRIPT_DIR")
WORKSPACE_DIR=$(dirname "$INFRA_DIR")

# --- Kaynak ve Hedef Dosyaları Tanımla ---
CONFIG_DIR="${WORKSPACE_DIR}/sentiric-config/environments"
OUTPUT_FILE="${INFRA_DIR}/.env.generated"
SECRETS_FILE="${CONFIG_DIR}/common/secrets.env"
PROFILE_FILE="${CONFIG_DIR}/profiles/${PROFILE}.env"

if [ ! -f "$PROFILE_FILE" ]; then
    echo "❌ HATA: Profil dosyası bulunamadı: $PROFILE_FILE"
    exit 1
fi

echo "🔧 Yapılandırma dosyası '${OUTPUT_FILE}' oluşturuluyor (Profil: ${PROFILE})..."

# --- Çıktı Dosyasını Başlat ---
> "$OUTPUT_FILE"
echo "# Auto-generated by Sentiric Orchestrator for profile: ${PROFILE}" >> "$OUTPUT_FILE"
echo "# DO NOT EDIT THIS FILE MANUALLY" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# --- Dosyaları Birleştir ---
while IFS= read -r line || [[ -n "$line" ]]; do
    line=$(echo "$line" | tr -d '\r')

    if [[ $line == source* ]]; then
        relative_path=$(echo "$line" | cut -d' ' -f2)
        source_file="${CONFIG_DIR}/${relative_path}"
        
        if [ -f "$source_file" ]; then
            echo "# Included from: ${relative_path}" >> "$OUTPUT_FILE"
            # DÜZELTME: grep hata verirse script'in çökmemesi için `|| true` ekliyoruz.
            (cat "$source_file" | tr -d '\r' | grep -vE '^\s*#|^\s*$' || true) >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
        else
            echo "⚠️ UYARI: Kaynak dosyası bulunamadı, atlanıyor: $source_file"
        fi
    fi
done < "$PROFILE_FILE"

# Sırları ekle
if [ -f "$SECRETS_FILE" ]; then
    echo "# Included from: common/secrets.env" >> "$OUTPUT_FILE"
    (cat "$SECRETS_FILE" | tr -d '\r' | grep -vE '^\s*#|^\s*$' || true) >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
fi

# --- Dinamik Değişkenleri Ekle ---
echo "# Dynamically added by Orchestrator" >> "$OUTPUT_FILE"
DETECTED_IP="127.0.0.1" # Varsayılan değer
if command -v ip &> /dev/null; then
    IP_CANDIDATE=$(ip addr | grep 'inet ' | grep -v '127.0.0.1' | awk '{print $2}' | cut -d'/' -f1 | head -n 1)
    if [ -n "$IP_CANDIDATE" ]; then
      DETECTED_IP=$IP_CANDIDATE
    fi
fi
echo "PUBLIC_IP=${DETECTED_IP}" >> "$OUTPUT_FILE"
TAG=${TAG:-latest}
echo "TAG=${TAG}" >> "$OUTPUT_FILE"
echo "CONFIG_REPO_PATH=../sentiric-config" >> "$OUTPUT_FILE"

echo "✅ Yapılandırma başarıyla oluşturuldu."