#!/bin/bash
set -e

# Bu script, Docker Compose iÃ§in son .env dosyasÄ±nÄ± oluÅŸturur.
# TÃ¼m karmaÅŸÄ±k yol hesaplamalarÄ±nÄ± terk edip, dosyalarÄ± manuel olarak birleÅŸtirir.
# Bu, WSL dahil tÃ¼m ortamlarda hatasÄ±z Ã§alÄ±ÅŸmayÄ± garanti eder.

PROFILE=${1:-dev}

# --- Temel Dizinleri TanÄ±mla ---
# Script'in bulunduÄŸu dizinden yola Ã§Ä±karak ana dizinleri buluyoruz.
SCRIPT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
INFRA_DIR=$(dirname "$SCRIPT_DIR")
WORKSPACE_DIR=$(dirname "$INFRA_DIR")

# --- Kaynak ve Hedef DosyalarÄ± TanÄ±mla ---
CONFIG_DIR="${WORKSPACE_DIR}/sentiric-config/environments"
OUTPUT_FILE="${INFRA_DIR}/.env.generated"
PROFILE_FILE="${CONFIG_DIR}/profiles/${PROFILE}.env"

if [ ! -f "$PROFILE_FILE" ]; then
    echo "âŒ HATA: Profil dosyasÄ± bulunamadÄ±: $PROFILE_FILE"
    exit 1
fi

echo "ğŸ”§ YapÄ±landÄ±rma dosyasÄ± '${OUTPUT_FILE}' oluÅŸturuluyor (Profil: ${PROFILE})..."

# --- Ã‡Ä±ktÄ± DosyasÄ±nÄ± BaÅŸlat ---
{
    echo "# Auto-generated by Sentiric Orchestrator for profile: ${PROFILE}"
    echo "# DO NOT EDIT THIS FILE MANUALLY"
    echo ""
} > "$OUTPUT_FILE"

# --- DosyalarÄ± Manuel Olarak BirleÅŸtir ---
# Profil dosyasÄ±nÄ± satÄ±r satÄ±r oku
while IFS= read -r line || [[ -n "$line" ]]; do
    # SatÄ±r "source" ile baÅŸlÄ±yorsa
    if [[ $line == source* ]]; then
        # `source common/platform.env` gibi bir satÄ±rdan dosya yolunu al
        relative_path=$(echo "$line" | cut -d' ' -f2)
        # Yolu, ana config dizinine gÃ¶re birleÅŸtir
        source_file="${CONFIG_DIR}/${relative_path}"

        if [ -f "$source_file" ]; then
            # DosyanÄ±n iÃ§eriÄŸini Ã§Ä±ktÄ±ya ekle
            echo "# Included from: ${relative_path}" >> "$OUTPUT_FILE"
            grep -vE '^\s*#|^\s*$' "$source_file" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE"
        else
            echo "âš ï¸ UYARI: Kaynak dosyasÄ± bulunamadÄ±, atlanÄ±yor: $source_file"
        fi
    fi
done < "$PROFILE_FILE"

# --- SÄ±rlarÄ± ve Dinamik DeÄŸiÅŸkenleri Ekle ---
SECRETS_FILE="${CONFIG_DIR}/common/secrets.env"
if [ -f "$SECRETS_FILE" ]; then
    echo "# Included from: common/secrets.env" >> "$OUTPUT_FILE"
    grep -vE '^\s*#|^\s*$' "$SECRETS_FILE" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
fi

echo "# Dynamically added by Orchestrator" >> "$OUTPUT_FILE"
DETECTED_IP=$(hostname -I | awk '{print $1}')
echo "PUBLIC_IP=${DETECTED_IP}" >> "$OUTPUT_FILE"
TAG=${TAG:-latest}
echo "TAG=${TAG}" >> "$OUTPUT_FILE"
echo "CONFIG_REPO_PATH=../sentiric-config" >> "$OUTPUT_FILE"

# Windows satÄ±r sonlarÄ±nÄ± temizle
sed -i 's/\r$//' "$OUTPUT_FILE"

echo "âœ… YapÄ±landÄ±rma baÅŸarÄ±yla oluÅŸturuldu."