#!/bin/bash
set -e

# Bu script, Docker Compose için son .env dosyasını oluşturur.
# Sadece `source` komutlarını kopyalamak yerine, bu dosyaları gerçekten "source" ederek
# içlerindeki değişkenleri çözer ve nihai KEY=VALUE çiftlerini yazar.

PROFILE=${1:-dev}
CONFIG_DIR="../sentiric-config/environments"
OUTPUT_FILE=".env.generated"
SECRETS_FILE="${CONFIG_DIR}/common/secrets.env"
PROFILE_FILE="${CONFIG_DIR}/profiles/${PROFILE}.env"

if [ ! -f "$PROFILE_FILE" ]; then
    echo "❌ HATA: Profil dosyası bulunamadı: $PROFILE_FILE"
    exit 1
fi

echo "🔧 Yapılandırma dosyası '${OUTPUT_FILE}' oluşturuluyor (Profil: ${PROFILE})..."

# Çıktı dosyasını temizle ve başlık ekle
echo "# Auto-generated by Sentiric Orchestrator for profile: ${PROFILE}" > "$OUTPUT_FILE"
echo "# DO NOT EDIT THIS FILE MANUALLY" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Geçici bir shell script'i oluşturarak tüm source işlemlerini yap
TEMP_SCRIPT=$(mktemp)
# Profilden gelen source satırlarını geçici scripte yaz
grep '^source ' "$PROFILE_FILE" > "$TEMP_SCRIPT"

# Sırları da ekle, eğer varsa
if [ -f "$SECRETS_FILE" ]; then
    # Sırlardaki yorumları ve boş satırları temizle
    grep -vE '^\s*#|^\s*$' "$SECRETS_FILE" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
fi

# Geçici script'i çalıştır ve sadece büyük harfle başlayan değişkenleri al
# Bu, PATH, HOME gibi sistem değişkenlerinin sızmasını engeller
(
  # shellcheck source=/dev/null
  source "$TEMP_SCRIPT"
  # Tüm değişkenleri yazdır ve sadece BÜYÜK harfle başlayanları filtrele
  env | grep '^[A-Z_][A-Z0-9_]*='
) >> "$OUTPUT_FILE"

# Geçici script'i sil
rm -f "$TEMP_SCRIPT"

# Dinamik değişkenleri ekle
echo "" >> "$OUTPUT_FILE"
echo "# Dynamically added by Orchestrator" >> "$OUTPUT_FILE"
# WSL'de doğru IP'yi bulmak için daha sağlam bir yöntem
DETECTED_IP=$(ip -4 addr show eth0 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
echo "PUBLIC_IP=${DETECTED_IP}" >> "$OUTPUT_FILE"
TAG=${TAG:-latest}
echo "TAG=${TAG}" >> "$OUTPUT_FILE"
echo "CONFIG_REPO_PATH=../sentiric-config" >> "$OUTPUT_FILE"

# Sonuç dosyası içindeki potansiyel Windows satır sonlarını (CR) temizle
sed -i 's/\r$//' "$OUTPUT_FILE"

echo "✅ Yapılandırma başarıyla oluşturuldu."