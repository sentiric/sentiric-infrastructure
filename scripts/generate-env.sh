#!/bin/bash
set -e

# Bu script, Docker Compose iÃ§in son .env dosyasÄ±nÄ± oluÅŸturur.
# Kendi konumunu bularak, 'source' komutlarÄ±ndaki gÃ¶receli yollarÄ±
# doÄŸru bir ÅŸekilde Ã§Ã¶zer ve nihai KEY=VALUE Ã§iftlerini yazar.

PROFILE=${1:-dev}

# --- DÃœZELTME: Script'in kendi dizinini bularak yollarÄ± saÄŸlamlaÅŸtÄ±rÄ±yoruz ---
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
# SCRIPT_DIR -> /path/to/sentiric-infrastructure/scripts
INFRA_DIR=$(dirname "$SCRIPT_DIR")
# INFRA_DIR -> /path/to/sentiric-infrastructure
WORKSPACE_DIR=$(dirname "$INFRA_DIR")
# WORKSPACE_DIR -> /path/to/sentiric

CONFIG_DIR="${WORKSPACE_DIR}/sentiric-config/environments"
OUTPUT_FILE="${INFRA_DIR}/.env.generated"
SECRETS_FILE="${CONFIG_DIR}/common/secrets.env"
PROFILE_FILE="${CONFIG_DIR}/profiles/${PROFILE}.env"

if [ ! -f "$PROFILE_FILE" ]; then
    echo "âŒ HATA: Profil dosyasÄ± bulunamadÄ±: $PROFILE_FILE"
    exit 1
fi

echo "ğŸ”§ YapÄ±landÄ±rma dosyasÄ± '${OUTPUT_FILE}' oluÅŸturuluyor (Profil: ${PROFILE})..."

# Ã‡Ä±ktÄ± dosyasÄ±nÄ± temizle ve baÅŸlÄ±k ekle
echo "# Auto-generated by Sentiric Orchestrator for profile: ${PROFILE}" > "$OUTPUT_FILE"
echo "# DO NOT EDIT THIS FILE MANUALLY" >> "$OUTPUT_FILE"
echo "" >> "$OUTPUT_FILE"

# Profil dosyasÄ±ndaki tÃ¼m 'source' komutlarÄ±nÄ± oku ve iÅŸle
while IFS= read -r line || [[ -n "$line" ]]; do
    if [[ $line == source* ]]; then
        # `source ../common/platform.env` gibi bir satÄ±rÄ± al
        # ve tam yolunu oluÅŸtur
        relative_path=$(echo "$line" | cut -d' ' -f2)
        # Profil dosyasÄ±nÄ±n bulunduÄŸu dizine gÃ¶re yolu Ã§Ã¶z
        source_file_path="${CONFIG_DIR}/profiles/${relative_path}"
        
        if [ -f "$source_file_path" ]; then
            # Dosyadaki yorumlarÄ± ve boÅŸ satÄ±rlarÄ± atla, geri kalanÄ±nÄ± ekle
            grep -vE '^\s*#|^\s*$' "$source_file_path" >> "$OUTPUT_FILE"
            echo "" >> "$OUTPUT_FILE" # Okunabilirlik iÃ§in boÅŸluk ekle
        else
            echo "âš ï¸ UYARI: Kaynak dosyasÄ± bulunamadÄ±, atlanÄ±yor: $source_file_path"
        fi
    fi
done < "$PROFILE_FILE"

# SÄ±rlarÄ± da ekle, eÄŸer varsa
if [ -f "$SECRETS_FILE" ]; then
    echo "# Included from: secrets.env" >> "$OUTPUT_FILE"
    grep -vE '^\s*#|^\s*$' "$SECRETS_FILE" >> "$OUTPUT_FILE"
    echo "" >> "$OUTPUT_FILE"
fi

# Dinamik deÄŸiÅŸkenleri ekle
echo "# Dynamically added by Orchestrator" >> "$OUTPUT_FILE"
# DÃœZELTME: WSL iÃ§in daha gÃ¼venilir IP bulma yÃ¶ntemi
DETECTED_IP=$(hostname -I | awk '{print $1}')
echo "PUBLIC_IP=${DETECTED_IP}" >> "$OUTPUT_FILE"
TAG=${TAG:-latest}
echo "TAG=${TAG}" >> "$OUTPUT_FILE"
echo "CONFIG_REPO_PATH=../sentiric-config" >> "$OUTPUT_FILE"

# SonuÃ§ dosyasÄ± iÃ§indeki potansiyel Windows satÄ±r sonlarÄ±nÄ± (CR) temizle
if command -v dos2unix &> /dev/null; then
    dos2unix "$OUTPUT_FILE"
elif command -v sed &> /dev/null; then
    sed -i 's/\r$//' "$OUTPUT_FILE"
fi

echo "âœ… YapÄ±landÄ±rma baÅŸarÄ±yla oluÅŸturuldu."